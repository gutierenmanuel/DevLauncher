#!/bin/bash
# Lanzador Universal de Scripts de Desarrollo
# Navegaci√≥n jer√°rquica: Carpeta ‚Üí Script

# Colores
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
GRAY='\033[0;90m'
BOLD='\033[1m'
NC='\033[0m'

# Obtener el directorio ra√≠z del proyecto
SCRIPT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$SCRIPT_ROOT/scripts"
STATIC_DIR="$SCRIPT_ROOT/static"

# Cargar librer√≠a com√∫n
source "$SCRIPTS_DIR/lib/common.sh"

# ==========================================
# FUNCIONES DEL LANZADOR
# ==========================================

# Obtener icono para cada categor√≠a
get_category_icon() {
    local category="$1"
    case "$category" in
        build) echo "üèóÔ∏è" ;;
        dev) echo "üíª" ;;
        inicializar_repos) echo "üÜï" ;;
        instaladores) echo "üì¶" ;;
        utils|utilidades) echo "üîß" ;;
        *) echo "üìÅ" ;;
    esac
}

# Obtener descripci√≥n de categor√≠a
get_category_description() {
    local category="$1"
    case "$category" in
        build) echo "Scripts de compilaci√≥n y construcci√≥n" ;;
        dev) echo "Scripts de desarrollo y servidor" ;;
        inicializar_repos) echo "Inicializadores de proyectos nuevos" ;;
        instaladores) echo "Instaladores de herramientas y dependencias" ;;
        utils|utilidades) echo "Utilidades y herramientas varias" ;;
        *) echo "Scripts varios" ;;
    esac
}

# Extraer descripci√≥n de un script
get_script_description() {
    local script_path="$1"
    local desc=""
    
    # Buscar l√≠nea con descripci√≥n (l√≠neas 2-5)
    desc=$(head -n 5 "$script_path" | grep -E "^#[[:space:]]*(Script|Descripci√≥n|Description)" | head -n1 | sed 's/^#[[:space:]]*//' | sed 's/Script[[:space:]]*//')
    
    if [ -z "$desc" ]; then
        local filename=$(basename "$script_path" .sh)
        desc="${filename//_/ }"
    fi
    
    echo "$desc"
}

# Listar categor√≠as disponibles
list_categories() {
    local platform="$1"
    local scan_dir="$SCRIPTS_DIR/$platform"
    
    find "$scan_dir" -mindepth 1 -maxdepth 1 -type d ! -name "lib" | sort | while read -r dir; do
        basename "$dir"
    done
}

# Listar scripts en una categor√≠a
list_scripts_in_category() {
    local platform="$1"
    local category="$2"
    local category_dir="$SCRIPTS_DIR/$platform/$category"
    
    if [ "$platform" = "linux" ]; then
        find "$category_dir" -type f -name "*.sh" ! -name "example_*" | sort
    else
        find "$category_dir" -type f \( -name "*.ps1" -o -name "*.bat" \) | sort
    fi
}

# Contar scripts en una categor√≠a
count_scripts_in_category() {
    local platform="$1"
    local category="$2"
    list_scripts_in_category "$platform" "$category" | wc -l
}

# Men√∫ de categor√≠as
show_category_menu() {
    local platform="$1"
    
    progress "Escaneando categor√≠as..."
    echo ""
    
    local -a categories=()
    local -a category_displays=()
    
    while IFS= read -r category; do
        if [ -n "$category" ]; then
            local count=$(count_scripts_in_category "$platform" "$category")
            if [ "$count" -gt 0 ]; then
                categories+=("$category")
                local icon=$(get_category_icon "$category")
                local desc=$(get_category_description "$category")
                category_displays+=("$icon  $category - $desc ($count scripts)")
            fi
        fi
    done < <(list_categories "$platform")
    
    if [ ${#categories[@]} -eq 0 ]; then
        error "No se encontraron categor√≠as"
        return 1
    fi
    
    echo -e "${YELLOW}${BOLD}Selecciona una categor√≠a:${NC}"
    echo ""
    
    # Usar fzf si est√° disponible
    if command -v fzf &> /dev/null; then
        local selection
        selection=$(printf '%s\n' "${category_displays[@]}" | fzf \
            --height=60% \
            --border \
            --prompt="üìÅ Selecciona una categor√≠a: " \
            --header="‚Üë‚Üì Navegar | Enter Seleccionar | Esc Salir" \
            --color=bg+:#2d3748,fg+:#ffffff,hl:#4299e1,hl+:#4299e1)
        
        if [ -n "$selection" ]; then
            # Extraer nombre de categor√≠a
            local selected_category=$(echo "$selection" | sed -E 's/^[^ ]+ +([^ ]+) -.*/\1/')
            show_script_menu "$platform" "$selected_category"
        else
            warning "Cancelado"
        fi
    else
        show_category_menu_select "$platform" "${categories[@]}"
    fi
}

# Men√∫ de categor√≠as con select
show_category_menu_select() {
    local platform="$1"
    shift
    local categories=("$@")
    
    echo -e "${YELLOW}${BOLD}Selecciona una categor√≠a:${NC}"
    echo ""
    
    local i=1
    for category in "${categories[@]}"; do
        local icon=$(get_category_icon "$category")
        local desc=$(get_category_description "$category")
        local count=$(count_scripts_in_category "$platform" "$category")
        echo -e "${CYAN}$i)${NC} $icon  ${BOLD}$category${NC}"
        echo -e "   ${GRAY}$desc ($count scripts)${NC}"
        ((i++))
    done
    echo -e "${CYAN}0)${NC} ${RED}‚Üê Salir${NC}"
    echo ""
    
    read -p "Opci√≥n: " choice
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#categories[@]} ]; then
        local idx=$((choice - 1))
        show_script_menu "$platform" "${categories[$idx]}"
    elif [ "$choice" = "0" ]; then
        warning "Cancelado"
    else
        error "Opci√≥n inv√°lida"
    fi
}

# Men√∫ de scripts dentro de una categor√≠a
show_script_menu() {
    local platform="$1"
    local category="$2"
    
    echo ""
    local icon=$(get_category_icon "$category")
    echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    printf "${PURPLE}‚ïë${NC} $icon  %-52s ${PURPLE}‚ïë${NC}\n" "$category"
    echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    local -a scripts=()
    local -a script_paths=()
    local -a script_displays=()
    
    while IFS= read -r script_path; do
        if [ -f "$script_path" ]; then
            local filename=$(basename "$script_path")
            local description=$(get_script_description "$script_path")
            
            scripts+=("$filename")
            script_paths+=("$script_path")
            script_displays+=("$filename - $description")
        fi
    done < <(list_scripts_in_category "$platform" "$category")
    
    if [ ${#scripts[@]} -eq 0 ]; then
        error "No se encontraron scripts en esta categor√≠a"
        return 1
    fi
    
    # Usar fzf si est√° disponible
    if command -v fzf &> /dev/null; then
        local selection
        selection=$(printf '%s\n' "${script_displays[@]}" | fzf \
            --height=60% \
            --border \
            --prompt="üìÑ Selecciona un script: " \
            --header="‚Üë‚Üì Navegar | Enter Ejecutar | Esc Volver" \
            --color=bg+:#2d3748,fg+:#ffffff,hl:#4299e1,hl+:#4299e1)
        
        if [ -n "$selection" ]; then
            # Encontrar el √≠ndice
            local idx=0
            for i in "${!script_displays[@]}"; do
                if [ "${script_displays[$i]}" = "$selection" ]; then
                    idx=$i
                    break
                fi
            done
            
            execute_script "${script_paths[$idx]}"
            
            # Preguntar si quiere ejecutar otro
            echo ""
            if confirm "¬øEjecutar otro script de esta categor√≠a?" "n"; then
                show_script_menu "$platform" "$category"
            else
                show_category_menu "$platform"
            fi
        else
            show_category_menu "$platform"
        fi
    else
        show_script_menu_select "$platform" "$category" "${script_paths[@]}"
    fi
}

# Men√∫ de scripts con select
show_script_menu_select() {
    local platform="$1"
    local category="$2"
    shift 2
    local script_paths=("$@")
    
    echo -e "${YELLOW}${BOLD}Selecciona un script:${NC}"
    echo ""
    
    local i=1
    for script_path in "${script_paths[@]}"; do
        local filename=$(basename "$script_path")
        local description=$(get_script_description "$script_path")
        echo -e "${CYAN}$i)${NC} ${BOLD}$filename${NC}"
        echo -e "   ${GRAY}$description${NC}"
        ((i++))
    done
    echo -e "${CYAN}b)${NC} ${YELLOW}‚Üê Volver a categor√≠as${NC}"
    echo -e "${CYAN}0)${NC} ${RED}‚Üê Salir${NC}"
    echo ""
    
    read -p "Opci√≥n: " choice
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#script_paths[@]} ]; then
        local idx=$((choice - 1))
        execute_script "${script_paths[$idx]}"
        
        echo ""
        if confirm "¬øEjecutar otro script?" "n"; then
            show_script_menu_select "$platform" "$category" "${script_paths[@]}"
        else
            show_category_menu "$platform"
        fi
    elif [ "$choice" = "b" ] || [ "$choice" = "B" ]; then
        show_category_menu "$platform"
    elif [ "$choice" = "0" ]; then
        warning "Saliendo..."
    else
        error "Opci√≥n inv√°lida"
        sleep 1
        show_script_menu_select "$platform" "$category" "${script_paths[@]}"
    fi
}

# Ejecutar script seleccionado
execute_script() {
    local script_path="$1"
    
    if [ ! -f "$script_path" ]; then
        error "El script no existe: $script_path"
        return 1
    fi
    
    local script_name=$(basename "$script_path")
    
    echo ""
    echo -e "${CYAN}${BOX_TL}$(printf '%*s' 58 | tr ' ' "${BOX_H}")${BOX_TR}${NC}"
    local name_len=${#script_name}
    local padding=$((43 - name_len))
    echo -e "${CYAN}${BOX_V}${NC} ${MAGENTA}‚ö° Ejecutando:${NC} ${BOLD}$script_name${NC}$(printf "%${padding}s")${CYAN}${BOX_V}${NC}"
    echo -e "${CYAN}${BOX_BL}$(printf '%*s' 58 | tr ' ' "${BOX_H}")${BOX_BR}${NC}"
    echo ""
    
    # Hacer ejecutable
    chmod +x "$script_path"
    
    # Ejecutar seg√∫n extensi√≥n
    if [[ "$script_path" == *.sh ]]; then
        bash "$script_path"
    elif [[ "$script_path" == *.ps1 ]]; then
        pwsh "$script_path" 2>/dev/null || powershell "$script_path"
    elif [[ "$script_path" == *.bat ]]; then
        cmd.exe /c "$script_path"
    fi
    
    local exit_code=$?
    
    echo ""
    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}${BOX_TL}$(printf '%*s' 58 | tr ' ' "${BOX_H}")${BOX_TR}${NC}"
        echo -e "${GREEN}${BOX_V}${NC} ${GREEN}‚úì Script completado exitosamente${NC}$(printf '%*s' 24)${GREEN}${BOX_V}${NC}"
        echo -e "${GREEN}${BOX_BL}$(printf '%*s' 58 | tr ' ' "${BOX_H}")${BOX_BR}${NC}"
    else
        local exit_len=${#exit_code}
        local padding=$((19 - exit_len))
        echo -e "${RED}${BOX_TL}$(printf '%*s' 58 | tr ' ' "${BOX_H}")${BOX_TR}${NC}"
        echo -e "${RED}${BOX_V}${NC} ${RED}‚úó El script fall√≥ con c√≥digo de salida: $exit_code${NC}$(printf "%${padding}s")${RED}${BOX_V}${NC}"
        echo -e "${RED}${BOX_BL}$(printf '%*s' 58 | tr ' ' "${BOX_H}")${BOX_BR}${NC}"
    fi
    
    return $exit_code
}

# Listar todos los scripts (modo plano)
list_all_scripts() {
    local platform="$1"
    
    show_header
    
    echo -e "${GRAY}Plataforma: $platform${NC}"
    echo ""
    
    local current_category=""
    
    while IFS= read -r category; do
        if [ -n "$category" ]; then
            local count=$(count_scripts_in_category "$platform" "$category")
            if [ "$count" -gt 0 ]; then
                echo ""
                local icon=$(get_category_icon "$category")
                local desc=$(get_category_description "$category")
                echo -e "${PURPLE}$icon  ${BOLD}$category${NC}"
                echo -e "${GRAY}   $desc${NC}"
                echo -e "${GRAY}   $(printf '‚îÄ%.0s' {1..58})${NC}"
                
                while IFS= read -r script_path; do
                    local filename=$(basename "$script_path")
                    local description=$(get_script_description "$script_path")
                    echo -e "   ${GREEN}‚Ä¢${NC} ${CYAN}$filename${NC}"
                    echo -e "     ${GRAY}$description${NC}"
                done < <(list_scripts_in_category "$platform" "$category")
            fi
        fi
    done < <(list_categories "$platform")
    
    echo ""
}

# ==========================================
# FUNCI√ìN PRINCIPAL
# ==========================================

main() {
    show_header
    
    # Detectar plataforma
    local platform="linux"
    if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "win32" ]]; then
        platform="win"
    fi
    
    echo -e "${GRAY}Plataforma: $platform | Directorio: $SCRIPTS_DIR/$platform${NC}"
    echo ""
    
    # Parsear argumentos
    case "${1:-}" in
        -l|--list)
            list_all_scripts "$platform"
            ;;
        -h|--help)
            echo "Uso: $0 [opciones]"
            echo ""
            echo "Opciones:"
            echo "  (sin opciones)  Mostrar men√∫ interactivo jer√°rquico"
            echo "  -l, --list      Listar todos los scripts organizados"
            echo "  -h, --help      Mostrar esta ayuda"
            echo ""
            echo "Navegaci√≥n:"
            echo "  1. Selecciona una categor√≠a (build, dev, instaladores, etc.)"
            echo "  2. Selecciona un script dentro de la categor√≠a"
            echo "  3. El script se ejecuta autom√°ticamente"
            echo ""
            echo "Atajos de teclado (con fzf):"
            echo "  ‚Üë/‚Üì           Navegar"
            echo "  Enter         Seleccionar"
            echo "  Esc           Volver/Salir"
            echo ""
            ;;
        "")
            show_category_menu "$platform"
            ;;
        *)
            error "Opci√≥n desconocida: $1"
            echo "Usa --help para ver las opciones disponibles"
            exit 1
            ;;
    esac
}

# Ejecutar
main "$@"
